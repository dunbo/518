<include file="../../Public/header" />
<link type="text/css" rel="stylesheet" href="/Public/css/tablelist.css" />
<script type="text/javascript" src='/Public/js/thickbox-compressed.js' ></script>
<link type="text/css" rel="stylesheet" href="/Public/css/thickbox.css" />
<script type="text/javascript" src="/Public/js/My97DatePicker/WdatePicker.js"></script>
<script>
	function select_all(){
		if($('#select_all').attr('checked') == 'checked'){
			$("input[id^=client_]").attr('checked','checked');
		
		}else if($('#select_all').attr('checked') != 'checked'){
			$("input[id^=client_]").attr('checked',false);
		}
	}
	
	function my_select(client_id){
		if($('#client_'+client_id+'').attr('checked') != 'checked'){
			$('#select_all').attr('checked',false);
		}
	}
	
	
	function param_go(url,cid,month,client_id,status){
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_status = $('#my_status').val();
	
		var my_go = "";
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		if(cid){
			my_go = my_go+"/cid/"+cid;
		}
		if(month){
			my_go = my_go+"/month/"+month;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		
		if(client_id){
			my_go = my_go+"/client_id/"+client_id;
		}
		if(status){
			my_go = my_go+"/status/"+status;
		}
		
		tb_show('',url+my_go+"?mm",false);
	}
	
	function edit_salvation(cid,month){
		param_go("__URL__/edit_salvation_show",cid,month);
	}
	
	function edit_comment(cid,month){
		param_go("__URL__/edit_comment_show/from/99",cid,month);
	}
	
	function change_status(client_id,month,status){
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_go = "";
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		if(month){
			my_go = my_go+"/month/"+month;
		}
		if(client_id){
			my_go = my_go+"/client_id/"+client_id;
		}
		if(status){
			my_go = my_go+"/status/"+status;
		}
		if(confirm("是否执行此操作！"))
		{
			location.href="__URL__/change_status"+my_go;
		}else{
			return false;
		}
		
	}
	
	function select_status(my_status){
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var my_go = '';
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		location.href="__URL__/forum_settle"+my_go;
	}
	
	function settle_entering(client_id,month){
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_status = $('#my_status').val();
		var my_go = "";
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		if(month){
			my_go = my_go+"/month/"+month;
		}
		if(client_id){
			my_go = my_go+"/client_id/"+client_id;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		tb_show('','__URL__/forum_settling'+my_go+"?mm",false);
	}
	
	function change_freeze(client_id,month,change,the_status){
		var my_status = $('#my_status').val();
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_go = "/from/99";
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		if(month){
			my_go = my_go+"/month/"+month;
		}
		if(client_id){
			my_go = my_go+"/client_id/"+client_id;
		}
		if(change){
			my_go = my_go+"/change/"+change;
		}
		if(the_status){
			my_go = my_go+"/the_status/"+the_status;
		}
		
		if(change == 3){
			if(confirm('确定解冻吗'))
		{
			location.href="__URL__/change_freeze"+my_go;
		}else{
			return false;
		}
		}else if(change == 5){
			tb_show('','__URL__/freeze_show/'+my_go+'?mm',false);
		}
		
		
	
	}

	
	function batch_entering(){
		var my_status = $('#my_status').val();
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_go = "";
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		var client_str=document.getElementsByName("client_id[]");
		
		var my_client = '';
		for(i=0;i<client_str.length;i++){
			if(client_str[i].checked == true){
				my_client += client_str[i].value+',';
			}
		}
		
		if(my_client){
			tb_show('',"__URL__/batch_entering_show/my_client/"+my_client+my_go+"?mm",false);
		}else{
			alert("请选择客户");
		}
	
	}
	
	function drive_list(){
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_go = "";
		var my_status = $('#my_status').val();
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		
		
		var var_checkbox = [];
		
		$('.checkbox_select_one').each(function(){
			if($(this).attr('checked')=='checked'){
				var_checkbox.push($(this).val());
			}
		});

		if(var_checkbox.length == 0){
			alert('请选择要导出的记录');
			return false;
		}

		my_go = my_go+"/list/"+var_checkbox.join('|');
		
		location.href='__URL__/forum_settle/from/1'+my_go;
	}
	
	function reject(client_id,month){
		var chname = $('#chname').val();
		var client_name = $('#client_name').val();
		var start_tm = $('#start_tm').val();
		var end_tm = $('#end_tm').val();
		var p = $('#p').val();
		var lr = $('#lr').val();
		var my_status = $('#my_status').val();
		var my_go = "";
		if(chname){
			my_go = my_go+"/chname/"+chname;
		}
		if(client_name){
			my_go = my_go+"/client_name/"+client_name;
		}
		if(start_tm){
			my_go = my_go+"/start_tm/"+start_tm;
		}
		if(end_tm){
			my_go = my_go+"/end_tm/"+end_tm;
		}
		if(p){
			my_go = my_go+"/p/"+p;
		}
		if(lr){
			my_go = my_go+"/lr/"+lr;
		}
		if(month){
			my_go = my_go+"/month/"+month;
		}
		if(client_id){
			my_go = my_go+"/client_id/"+client_id;
		}
		if(my_status){
			my_go = my_go+"/my_status/"+my_status;
		}
		if(confirm("是否执行此操作！"))
		{
			location.href='__URL__/financial_reject'+my_go;
		}else{
			return false;
		}
		
	}
</script>
<style type="text/css">
.table_list tbody td{padding:5px;}
</style>
<div>
	<div>
		<form action="__URL__/forum_settle" method="get">
		<table width="100%" cellpadding="0" cellspacing="0" class="search_table margin_top">
			<tr>
				<td width="20%">负 责 人：<input type="text" name="charge_name" id="charge_name" value="{$charge_name}" /></td>
				<td width="20%">客户名称：<input type="text" name="client_name" id="client_name" value="{$client_name}" /></td>
				<td>渠道名称：<input type="text" name="chname" id="chname" value="{$chname}" /></td>
			</tr>
			<tr>
				<td>数据月份：<input id="start_tm" name="start_tm" value="{$start_tm}" type="text" class="Wdate" onClick="WdatePicker({startDate:'%y-%M',dateFmt:'yyyy-MM'})">&nbsp;</td>
				<td>到&nbsp;<input id="end_tm" name="end_tm" value="{$end_tm}" type="text" class="Wdate" onClick="WdatePicker({startDate:'%y-%M',dateFmt:'yyyy-MM'})"></td>
				<td><input type="submit" value="搜索" class="search_btn"/></td>
			</tr>
		</table>
		</form>
	</div>
	<div style="margin:20px;"><input type="button" onclick="drive_list();" value="导出报表" /><input type="hidden" name="p" value="{$p}" id="p" /><input type="hidden" name="lr" value="{$lr}" id="lr" /></div>
	<div>
		<table class="table_list" cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th width="2%"><input type="checkbox" onclick="select_all();" id="select_all" /></th>
					<th width="5%">序号</th>
					<th width="5%">月份</th>
					<th width="5%">负责人</th>
					<th width="10%">客户名称</th>
					<th width="13%">渠道</th>
					<th width="10%">激活量</th>
					<th width="10%">日均激活量</th>
					<th width="10%">单价</th>
					<th width="10%">激活结算</th>
					<th width="5%"><select id="my_status" onchange="select_status(this.value);"><option value="0">状态</option><option value="3" <?php if($my_status == 3){ ?>selected<?php } ?>>待付款</option><option value="2" <?php if($my_status == 2){ ?>selected<?php } ?>>已付款</option><option value="5" <?php if($my_status == 5){ ?>selected<?php } ?>>已冻结</option></select></td>
					<th width="10%">备注</th>
					<th width="5%">操作</th>
				</tr>
			</thead>
			<tbody>
			<?php foreach($result as $key => $val){ ?>
			<tr>
				<td rowspan="<?php echo count($val['cid_result']); ?>"><input type="checkbox"  name="client_id[]" value="{$val.num}" id="client_{$val.client_id}_{$val.month}" onclick="my_select({$val.client_id});" class="checkbox_select_one" /></td>
				<td rowspan="<?php echo count($val['cid_result']); ?>">{$val.num}</td>
				<td rowspan="<?php echo count($val['cid_result']); ?>"><?php echo date('Y-m',strtotime($val['month'].'01')); ?></td>
				<td rowspan="<?php echo count($val['cid_result']); ?>">{$val.charge_name}</td>
				<td style="align:left;" rowspan="<?php echo count($val['cid_result']); ?>"><a href="__URL__/financial_settle/client_id/{$val.client_id}">{$val.client_name}</a></td>
				<td style="text-align:left;">
				<?php 
					echo '名称：'.$val['cid_result'][0]['chname'].'<br/>';
					echo '属性：'.$channel_attribute[$val['cid_result'][0]['channel_attribute']].'<br/>';
					echo '分类：'.$val['cid_result'][0]['channel_category_name'].'<br/>'; 
				?>
				</td>
				<td><a href="__URL__/channel_activation/cid/<?php echo $val['cid_result'][0]['cid']; ?>/month/{$val.month}"><?php echo $val['cid_result'][0]['activation']; ?></td>
				<td><?php echo $val['cid_result'][0]['average'];?></td>
				<td><?php echo $val['cid_result'][0]['price']; ?></td>
				<td rowspan="<?php echo count($val['cid_result']); ?>" style="text-align:left;">
				<?php 
					echo '应付：'.$val['all_amount_pay'].'<br/>';
					if($val['cid_result'][0]['status'] == 0 || $val['cid_result'][0]['status'] == 3)
					{
						echo '已付：0<br/>';
						echo '未付：'.$val['all_amount_pay'].'<br/>'; 
					}
					else
					{
						echo '已付：'.$val['cid_result'][0]['amount_paid'].'<br/>';
						echo '未付：'.$val['no_paid'].'<br/>'; 
					}					
				?>
				</td>

				<td rowspan="<?php echo count($val['cid_result']); ?>"><?php if($val['cid_result'][0]['status'] == 0){ ?>已冻结<?php }elseif($val['cid_result'][0]['status'] == 2){ ?>已付款<?php }elseif($val['cid_result'][0]['status'] == 3){ ?>未付款<?php } ?></td>
				<td><?php if(!$val['cid_result'][0]['comment']){ ?><a href="javascript:;" onclick="edit_comment(<?php echo $val['cid_result'][0]['cid']; ?>,{$val.month},2);" class="blue">编辑</a><?php }else{ ?><a href="javascript:;" onclick="edit_comment(<?php echo $val['cid_result'][0]['cid']; ?>,{$val.month},2);" class="blue"><?php echo $val['cid_result'][0]['comments'].'...'; ?></a><?php } ?></td>
				<td rowspan="<?php echo count($val['cid_result']); ?>"><?php if($val['cid_result'][0]['status'] == 3){ ?><a href="javascript:;" onclick="settle_entering({$val['client_id']},{$val.month});" class="blue">结算</a><?php } ?><br/><a href="__URL__/forum_detail/client_id/{$val.client_id}/month/{$val.month}/status/{$val['cid_result'][0]['status']}/bath_tm/{$val['cid_result'][0]['bath_tm']}" class="thickbox blue">详情</a><?php if($val['cid_result'][0]['status'] == 0){ ?><br/><a href="javascript:;" onclick="change_freeze({$val.client_id},{$val.month},3);"  class="blue">解冻</a><?php } ?><?php if($val['cid_result'][0]['status'] == 3){ ?><br/><a href="javascript:;" onclick="change_freeze({$val.client_id},{$val.month},5,{$val['cid_result'][0]['status']});" class="blue">冻结</a><?php } ?></td>
			</tr>

			<?php foreach(array_slice($val['cid_result'],1) as $k => $v){ ?>
				<tr>
				<td style="text-align:left;">
				<?php
					echo '名称：'.$v['chname'].'<br/>';
					echo '属性：'.$channel_attribute[$v['channel_attribute']].'<br/>';
					echo '分类：'.$v['channel_category_name'].'<br/>';
				?>
				</td>
				<td><a href="__URL__/channel_activation/cid/{$v.cid}/month/{$val.month}">{$v.activation}</a></td>
				<td>{$v.average}</td>
				<td>{$v.price}</td>
				<td><?php if(!$v['comment']){ ?><a href="javascript:;" onclick="edit_comment({$v.cid},{$val.month});"  class="blue">编辑</a><?php }else{ ?><a href="javascript:;" onclick="edit_comment({$v.cid},{$val.month});"  class="blue">{$v.comments}...</a><?php } ?></td>
				</tr>
				<?php } ?>
			<?php } ?>
				<tr>
					<td></td>
					<td>总计</td>
					<td>-</td>
					<td>-</td>
					<td>-</td>
					<td>-</td>
					<td>{$the_activation}</td>
					<td>{$the_average}</td>
					<td>-</td>
					<td>应付：{$the_amount_pay}<br/>已付：{$the_amount_paid}<br/>未付：{$the_no_paid}</td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>
		{$page}
	</div>
</div>